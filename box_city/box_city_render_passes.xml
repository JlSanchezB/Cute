<Root>
<Global>
  <Resource type="RootSignature" name="BuildHiZRootSignature">
    <RootParam index="0" type="DescriptorTable">
      <Range base_shader_register="0" size="2" type="UnorderedAccessBuffer"/>
      <Range base_shader_register="0" size="1" type="ShaderResource"/>
    </RootParam>
  </Resource>
  <Resource type="ComputePipelineState" name="BuildHiZ">
    <RootSignature>BuildHiZRootSignature</RootSignature>
    <ComputeShader entry_point="build_hz" target="cs_6_6">build_hz.hlsl</ComputeShader>
  </Resource>
</Global>
<Passes>
  <Pass name="SyncStaticGPUMemory" group="Auto">
    <Dependencies>
      <Resource name="StaticGPUMemoryBuffer" pre_condition_state="Init" post_update_state="Ready" access="UnorderedAccess"/>
    </Dependencies>
    <Commands>
      <SyncStaticGPUMemoryPass/>
    </Commands>
  </Pass>
  <Pass name="Main_Culling" group="Solids">
    <Dependencies>
      <Resource name="IndirectBoxBuffer" pre_condition_state="Init" post_update_state="FirstPass" access="UnorderedAccess"/>
      <Resource name="IndirectParametersBuffer" pre_condition_state="Init" post_update_state="FirstPass" access="UnorderedAccess"/>
      <Resource name="SecondPassIndirectBoxBuffer" pre_condition_state="Init" post_update_state="SecondPass" access="UnorderedAccess"/>
      <Resource name="SecondPassIndirectParametersBuffer" pre_condition_state="Init" post_update_state="SecondPass" access="UnorderedAccess"/>
      <Resource name="StaticGPUMemoryBuffer" pre_condition_state="Ready" access="AllShaderResource"/>
      <Texture2D name="HiZ" pre_condition_state="Alloc" post_update_state="FirstPass" access="AllShaderResource" format="R32_FLOAT" width="768" height="512" not_alias="true"/>
    </Dependencies>
    <Commands>
      <CullCityBoxes/>
    </Commands>
  </Pass>
  <Pass name="Main_Render" group="Solids">
    <Dependencies>
      <Resource name="IndirectBoxBuffer" pre_condition_state="FirstPass" post_update_state="SecondPass" access="AllShaderResource"/>
      <Resource name="IndirectParametersBuffer" pre_condition_state="FirstPass" post_update_state="SecondPass" access="IndirectArgument"/>
      <Resource name="StaticGPUMemoryBuffer" pre_condition_state="Ready" access="AllShaderResource"/>
      <DepthBuffer name="SceneDepth" pre_condition_state="Alloc" post_update_state="FirstPassReadyToCapture" access="Depth" format="D32_FLOAT" default_depth="0.f"/>
      <Resource name="BackBuffer" access="RenderTarget"/>
    </Dependencies>
    <Commands>
      <SetRenderTarget>
		    <RenderTarget>BackBuffer</RenderTarget>
        <DepthBuffer>SceneDepth</DepthBuffer>
	    </SetRenderTarget>
	    <ClearRenderTarget colour="0,0,0,0">BackBuffer</ClearRenderTarget>
      <ClearDepthStencil>SceneDepth</ClearDepthStencil>
      <DrawCityBoxes/>
    </Commands>
  </Pass>
  <Pass name="BuildHiZ" group="Solids">
    <Dependencies>
      <Texture2D name="HiZ" pre_condition_state="FirstPass" post_update_state="SecondPass" access="UnorderedAccess" format="R32_FLOAT" width="768" height="512"/>
      <DepthBuffer name="SceneDepth" pre_condition_state="FirstPassReadyToCapture" post_update_state="SecondPass" format="D32_FLOAT" default_depth="0.f" access="AllShaderResource"/>
      <Buffer name="HiZ_atomic" pre_condition_state="Alloc" post_update_state="Free" access="UnorderedAccess" size ="4096" clear="true"/>
    </Dependencies>
    <Commands>
      <SetRootSignature pipe="Compute">BuildHiZRootSignature</SetRootSignature>
      <SetDescriptorTable pipe="Compute" root_param="0">
        <Descriptor as="UnorderedAccess">HiZ</Descriptor>
        <Descriptor as="UnorderedAccess">HiZ_atomic</Descriptor>
        <Descriptor as="ShaderResource">SceneDepth</Descriptor>
      </SetDescriptorTable>
      <SetComputePipelineState>BuildHiZ</SetComputePipelineState>
      <DispatchCompute group_count_x="64" group_count_y="64"/>
    </Commands>
  </Pass>
  <Pass name="Second_Pass_Main_Culling" group="Solids">
    <Dependencies>
      <Resource name="IndirectBoxBuffer" pre_condition_state="SecondPass" post_update_state="SecondPassReady" access="UnorderedAccess"/>
      <Resource name="IndirectParametersBuffer" pre_condition_state="SecondPass" post_update_state="SecondPassReady" access="UnorderedAccess"/>
      <Resource name="SecondPassIndirectBoxBuffer" pre_condition_state="SecondPass" access="AllShaderResource"/>
      <Resource name="SecondPassIndirectParametersBuffer" pre_condition_state="SecondPass" access="AllShaderResource"/>
      <Resource name="StaticGPUMemoryBuffer" pre_condition_state="Ready" access="AllShaderResource"/>
      <Texture2D name="HiZ" pre_condition_state="SecondPass" post_update_state="SecondPassReadyToUpdate" access="AllShaderResource" format="R32_FLOAT" width="768" height="512" not_alias="true"/>
    </Dependencies>
    <Commands>
      <CullSecondPassCityBoxes/>
    </Commands>
  </Pass>
  <Pass name="Second_Pass_Main_Render" group="Solids">
    <Dependencies>
      <Resource name="IndirectBoxBuffer" pre_condition_state="SecondPassReady" access="AllShaderResource"/>
      <Resource name="IndirectParametersBuffer" pre_condition_state="SecondPassReady" access="IndirectArgument"/>
      <Resource name="StaticGPUMemoryBuffer" pre_condition_state="Ready" access="AllShaderResource"/>
      <DepthBuffer name="SceneDepth" pre_condition_state="SecondPass" post_update_state="SecondPassReadyToCapture" access="Depth" format="D32_FLOAT" default_depth="0.f"/>
      <Resource name="BackBuffer" access="RenderTarget"/>
    </Dependencies>
    <Commands>
      <SetRenderTarget>
        <RenderTarget>BackBuffer</RenderTarget>
        <DepthBuffer>SceneDepth</DepthBuffer>
      </SetRenderTarget>
      <DrawCityBoxes/>
    </Commands>
  </Pass>
  <Pass name="SecondPassBuildHiZ" group="Solids">
    <Dependencies>
      <Texture2D name="HiZ" pre_condition_state="SecondPassReadyToUpdate" post_update_state="Free" access="UnorderedAccess" format="R32_FLOAT" width="768" height="512"/>
      <DepthBuffer name="SceneDepth" pre_condition_state="SecondPassReadyToCapture" post_update_state="Free" format="D32_FLOAT" default_depth="0.f" access="AllShaderResource"/>
      <Buffer name="HiZ_atomic" pre_condition_state="Alloc" post_update_state="Free" access="UnorderedAccess" size ="4096" clear="true"/>
    </Dependencies>
    <Commands>
      <SetRootSignature pipe="Compute">BuildHiZRootSignature</SetRootSignature>
      <SetDescriptorTable pipe="Compute" root_param="0">
        <Descriptor as="UnorderedAccess">HiZ</Descriptor>
        <Descriptor as="UnorderedAccess">HiZ_atomic</Descriptor>
        <Descriptor as="ShaderResource">SceneDepth</Descriptor>
      </SetDescriptorTable>
      <SetComputePipelineState>BuildHiZ</SetComputePipelineState>
      <DispatchCompute group_count_x="64" group_count_y="64"/>
    </Commands>
  </Pass>
</Passes>
</Root>
